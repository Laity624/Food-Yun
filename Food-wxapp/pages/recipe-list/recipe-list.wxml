<wxs src="./filter-utils.wxs" module="filterUtils" />
<view class="recipe-list-container">
  
  <!-- å¤´éƒ¨ -->
  <view class="header-section">
    <view class="header-content">
      <!-- æœç´¢æ¡† -->
      <view class="search-wrapper">
        <van-field
          value="{{searchValue}}"
          placeholder="ä»Šå¤©åƒä»€ä¹ˆï¼Ÿæœç´¢èœåæˆ–é£Ÿæ..."
          bind:input="onSearchInput"
          bind:confirm="onSearchConfirm"
          clearable
          left-icon="search"
          custom-style="background: #f5f5f5; border-radius: 16px; border: none;"
        />
      </view>
      
      <!-- æ·»åŠ æŒ‰é’® -->
      <!-- <view class="add-btn" bindtap="onAddClick">
        <van-icon name="plus" size="20px" color="#fff" />
      </view> -->
    </view>
  </view>

  <!-- åœºæ™¯åˆ†ç±»ï¼ˆä¸»è¦ç­›é€‰ï¼‰ -->
  <view class="scene-section">
    <view class="section-header">
      <text class="section-title">æŒ‰åœºæ™¯é€‰æ‹©</text>
    </view>
    <view class="scene-grid">
      <block wx:for="{{quickFilters}}" wx:key="sceneId" wx:if="{{item.sceneId}}">
        <view
          class="scene-tag scene-tag-{{item.sceneId}} {{currentQuickFilter === item.sceneId ? 'active' : ''}}"
          data-sceneid="{{item.sceneId}}"
          bindtap="onQuickFilterChange"
        >
          <view class="scene-emoji">{{item.emoji}}</view>
          <view class="scene-name">{{item.name}}</view>
        </view>
      </block>
    </view>
  </view>

  <!-- é£Ÿæå¿«é€Ÿç­›é€‰ -->
  <view class="ingredient-section">
    <view class="section-header">
      <text class="section-title">æŒ‰é£Ÿæç­›é€‰</text>
      <view class="more-filter-btn" bindtap="onFilterClick">
        <text class="more-filter-text">æ›´å¤šç­›é€‰</text>
        <van-icon name="arrow-down" size="12px" color="#3b82f6" />
      </view>
    </view>
    <scroll-view class="ingredient-scroll" scroll-x="true" show-scrollbar="{{false}}">
      <view class="ingredient-list">
        <block wx:for="{{ingredientCategories}}" wx:key="id" wx:if="{{index < 6}}">
          <view
            class="ingredient-tag {{selectedIngredients.indexOf(item.id) !== -1 ? 'selected' : ''}}"
            data-id="{{item.id}}"
            bindtap="onIngredientToggle"
          >
            <text class="ingredient-emoji">{{item.emoji}}</text>
            <text class="ingredient-name">{{item.name}}</text>
          </view>
        </block>
      </view>
    </scroll-view>
  </view>

  <!-- å·²é€‰ç­›é€‰æ¡ä»¶æ˜¾ç¤º -->
  <view wx:if="{{hasActiveFilters}}" class="selected-filters">
    <view class="selected-filters-header">
      <text class="selected-filters-label">å½“å‰ç­›é€‰ï¼š</text>
      <view class="reset-filters-btn" bindtap="onResetAllFilters">
        <van-icon name="refresh" size="14px" color="#3b82f6" />
        <text class="reset-text">é‡ç½®</text>
      </view>
    </view>
    <scroll-view class="selected-filters-scroll" scroll-x="true" show-scrollbar="{{false}}">
      <view class="selected-filters-list">
        
        <!-- å¿«é€Ÿç­›é€‰ -->
        <block wx:if="{{currentQuickFilter}}">
          <view class="selected-filter-item quick-filter">
            <text>{{currentQuickFilterName}}</text>
            <van-icon name="cross" size="12px" bind:click="onRemoveQuickFilter" />
          </view>
        </block>

        <!-- åœºæ™¯ç­›é€‰ -->
        <block wx:for="{{selectedScenes}}" wx:key="*this">
          <view class="selected-filter-item scene-filter">
            <text>{{filterUtils.getSceneName(sceneCategories, item)}}</text>
            <van-icon name="cross" size="12px" data-id="{{item}}" bind:click="onRemoveScene" />
          </view>
        </block>

        <!-- é£Ÿæç­›é€‰ -->
        <block wx:for="{{selectedIngredients}}" wx:key="*this">
          <view class="selected-filter-item ingredient-filter">
            <text>{{filterUtils.getIngredientName(ingredientCategories, item)}}</text>
            <van-icon name="cross" size="12px" data-id="{{item}}" bind:click="onRemoveIngredient" />
          </view>
        </block>

        <!-- å¯é€‰æ ‡ç­¾ç­›é€‰ -->
        <block wx:for="{{selectedOptionalTags}}" wx:key="*this">
          <view class="selected-filter-item optional-tag-filter">
            <text>{{filterUtils.getOptionalTagName(cookingMethods, flavorTypes, item)}}</text>
            <van-icon name="cross" size="12px" data-id="{{item}}" bind:click="onRemoveOptionalTag" />
          </view>
        </block>

        <!-- æ—¶é—´ç­›é€‰ -->
        <block wx:if="{{selectedTime}}">
          <view class="selected-filter-item time-filter">
            <text>{{selectedTimeLabel}}</text>
            <van-icon name="cross" size="12px" bind:click="onRemoveTimeFilter" />
          </view>
        </block>

      </view>
    </scroll-view>
  </view>

  <!-- é«˜çº§ç­›é€‰é¢æ¿ -->
  <view wx:if="{{showFilter}}" class="advanced-filter-panel">
    <view class="advanced-filter-content">
      <!-- åˆ¶ä½œæ—¶é—´ -->
      <view class="filter-group">
        <text class="filter-group-title">åˆ¶ä½œæ—¶é—´</text>
        <view class="filter-options">
          <block wx:for="{{timeOptions}}" wx:key="id">
            <view class="filter-option {{selectedTime === item.id ? 'selected' : ''}}" bindtap="onTimeFilterToggle" data-time="{{item.id}}">
              <text class="option-emoji">{{item.emoji}}</text>
              <text class="option-text">{{item.label}}</text>
            </view>
          </block>
        </view>
      </view>
      

      <!-- çƒ¹é¥ªæ–¹å¼ -->
      <view class="filter-group">
        <text class="filter-group-title">çƒ¹é¥ªæ–¹å¼</text>
        <view class="filter-tags">
          <block wx:for="{{cookingMethods}}" wx:key="id">
            <view
              class="filter-tag {{selectedOptionalTags.indexOf(item.id) !== -1 ? 'selected' : ''}}"
              data-id="{{item.id}}"
              bindtap="onOptionalTagToggle"
            >
              <text>{{item.emoji}} {{item.name}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- å£å‘³ç‰¹è‰² -->
      <view class="filter-group">
        <text class="filter-group-title">å£å‘³ç‰¹è‰²</text>
        <view class="filter-tags">
          <block wx:for="{{flavorTypes}}" wx:key="id">
            <view
              class="filter-tag {{selectedOptionalTags.indexOf(item.id) !== -1 ? 'selected' : ''}}"
              data-id="{{item.id}}"
              bindtap="onOptionalTagToggle"
            >
              <text>{{item.emoji}} {{item.name}}</text>
            </view>
          </block>
        </view>
      </view>
    </view>
  </view>

  <!-- èœè°±åˆ—è¡¨ -->
  <view class="recipe-list">
    <block wx:for="{{recipes}}" wx:key="_id">
      <view 
        class="recipe-card"
        data-id="{{item._id}}"
        bindtap="onRecipeClick"
      >
        <view class="recipe-content">
          <image 
            class="recipe-image" 
            src="{{item.images[0] || '/images/default-recipe.png'}}" 
            mode="aspectFill"
          />
          <view class="recipe-info">
            <text class="recipe-title">{{item.name}}</text>
            <text class="recipe-description">{{item.description || 'ç»å…¸å®¶å¸¸èœï¼Œè¥å…»ç¾å‘³'}}</text>
            
            <!-- åˆ¶ä½œä¿¡æ¯ -->
            <view class="recipe-meta">
              <view class="meta-item">
                <van-icon name="clock-o" size="12px" color="#999" />
                <text>{{item.preparationTimeDisplay || '30åˆ†é’Ÿ'}}</text>
              </view>
              <view class="meta-item">
                <van-icon name="friends-o" size="12px" color="#999" />
                <text>{{item.servingSizeDisplay || '2-3äºº'}}</text>
              </view>
              <view class="meta-item">
                <van-icon name="star" size="12px" color="#ffd700" />
                <text>4.8</text>
              </view>
            </view>

            <!-- æ ‡ç­¾ -->
            <view class="recipe-tags">
              <text class="recipe-tag scene-tag">{{item.sceneDisplay || 'æ—¥å¸¸'}}</text>
              <text class="recipe-tag ingredient-tag">{{item.ingredientDisplay || 'å®¶å¸¸'}}</text>
              <text wx:if="{{item.optionalTags && item.optionalTags.length > 0}}" class="recipe-tag optional-tag">
                {{filterUtils.getOptionalTagName(cookingMethods, flavorTypes, item.optionalTags[0])}}
              </text>
            </view>
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading && recipes.length === 0}}" class="loading-state">
    <van-loading size="24px" />
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view wx:if="{{loading && recipes.length > 0}}" class="load-more">
    <van-loading size="20px" />
    <text>åŠ è½½æ›´å¤š...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{!loading && recipes.length === 0}}" class="empty-state">
    <text class="empty-emoji">ğŸ³</text>
    <text class="empty-title">è¿˜æ²¡æœ‰å®¶åº­èœè°±</text>
    <text class="empty-desc">èµ¶å¿«æ·»åŠ ç¬¬ä¸€ä¸ªå®¶åº­èœè°±å§</text>
    <van-button type="primary" size="large" bind:click="onAddClick">
      åˆ›å»ºèœè°±
    </van-button>
  </view>

  <!-- æ²¡æœ‰æ›´å¤š -->
  <view wx:if="{{!loading && !hasMore && recipes.length > 0}}" class="no-more">
    <text>â€” å·²ç»åˆ°åº•äº† â€”</text>
  </view>

  <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
  <view class="fab" bindtap="onAddClick">
    <van-icon name="plus" size="24px" color="#fff" />
  </view>
</view>