<view class="recipe-container">

  <!-- 表单内容 -->
  <scroll-view class="form-content" scroll-y="true" show-scrollbar="{{false}}">
    
    <!-- 菜谱图片 -->
    <view class="form-section">
      <text class="section-label required">菜谱图片（{{formData.images.length}}/5）</text>
      <view class="images-container">
        <!-- 已上传的图片 -->
        <block wx:for="{{formData.images}}" wx:key="index">
          <view class="image-item">
            <image class="uploaded-image" src="{{item}}" mode="aspectFill" />
            <view class="image-delete" bindtap="removeImage" data-index="{{index}}">
              <van-icon name="cross" size="16px" color="#fff" />
            </view>
          </view>
        </block>

        <!-- 上传按钮 -->
        <view wx:if="{{formData.images.length < 5}}" class="image-upload" bindtap="onImageUpload">
          <van-icon name="photograph" size="32px" color="#cccccc" />
          <text class="upload-text">点击上传图片</text>
        </view>
      </view>
    </view>

    <!-- 基本信息 -->
    <view class="form-section">
      <view class="input-group">
        <text class="input-label required">菜谱名称</text>
        <van-field 
          value="{{formData.name}}" 
          placeholder="例如：红烧肉、番茄鸡蛋"
          maxlength="20"
          show-word-limit
          bind:change="onNameChange"
        />
      </view>

      <view class="input-group">
        <text class="input-label">菜谱描述</text>
        <van-field 
          value="{{formData.description}}" 
          placeholder="简单描述一下这道菜的特色..."
          type="textarea"
          maxlength="100"
          show-word-limit
          autosize
          bind:change="onDescriptionChange"
        />
      </view>
    </view>

    <!-- 场景分类（必选） -->
    <view class="form-section">
      <text class="section-label required">这是什么场景的菜？</text>
      <view class="scene-grid">
        <block wx:for="{{sceneCategories}}" wx:key="id">
          <view
            class="scene-card {{formData.sceneCategory === item.id ? 'selected' : ''}}"
            bindtap="onSceneCategorySelect"
            data-id="{{item.id}}"
          >
            <view class="scene-emoji">{{item.emoji}}</view>
            <view class="scene-name">{{item.name}}</view>
            <view class="scene-desc">{{item.description}}</view>
          </view>
        </block>
      </view>
    </view>

    <!-- 食材分类（必选） -->
    <view class="form-section">
      <text class="section-label required">主要食材是什么？</text>
      <view class="ingredient-grid">
        <block wx:for="{{ingredientCategories}}" wx:key="id">
          <view
            class="ingredient-card {{formData.ingredientCategory === item.id ? 'selected' : ''}}"
            bindtap="onIngredientCategorySelect"
            data-id="{{item.id}}"
          >
            <view class="ingredient-emoji">{{item.emoji}}</view>
            <view class="ingredient-name">{{item.name}}</view>
          </view>
        </block>
      </view>
    </view>

    <!-- 制作信息 -->
    <view class="form-section">
      <text class="section-label">制作信息</text>
      <view class="info-row">
        <view class="info-column">
          <text class="info-label">制作时间</text>
          <picker 
            range="{{preparationTimes}}" 
            range-key="label"
            value="{{formData.preparationTimeIndex}}"
            bindchange="onPreparationTimeChange"
          >
            <view class="picker-field">
              {{preparationTimes[formData.preparationTimeIndex].label || '请选择'}}
            </view>
          </picker>
        </view>

        <view class="info-column">
          <text class="info-label">难度等级</text>
          <picker 
            range="{{difficultyLevels}}" 
            range-key="label"
            value="{{formData.difficultyIndex}}"
            bindchange="onDifficultyChange"
          >
            <view class="picker-field">
              {{difficultyLevels[formData.difficultyIndex].label || '请选择'}}
            </view>
          </picker>
        </view>

        <view class="info-column">
          <text class="info-label">适合人数</text>
          <picker 
            range="{{servingSizes}}" 
            range-key="label"
            value="{{formData.servingSizeIndex}}"
            bindchange="onServingSizeChange"
          >
            <view class="picker-field">
              {{servingSizes[formData.servingSizeIndex].label || '请选择'}}
            </view>
          </picker>
        </view>
      </view>
    </view>

    <!-- 可选标签 -->
    <view class="form-section">
      <view class="optional-tags-header">
        <text class="section-label">更多标签（可选）</text>
        <text class="toggle-btn" bindtap="toggleMoreTags">
          {{showMoreTags ? '收起' : '展开'}}
          <van-icon name="{{showMoreTags ? 'arrow-up' : 'arrow-down'}}" size="12px" />
        </text>
      </view>
      
      
      <block wx:if="{{showMoreTags}}">
        <!-- 烹饪方式 -->
        <view class="tag-group">
          <text class="tag-group-title">烹饪方式</text>
          <view class="tag-list">
            <block wx:for="{{cookingMethods}}" wx:key="id">
              <view
                class="optional-tag {{item.selected ? 'selected' : 'unselected'}}"
                bindtap="onOptionalTagToggle"
                data-id="{{item.id}}"
              >
                <text wx:if="{{item.selected}}" class="tag-checkmark">✓ </text>{{item.emoji}} {{item.name}}
              </view>
            </block>
          </view>
        </view>
        
        <!-- 口味特色 -->
        <view class="tag-group">
          <text class="tag-group-title">口味特色</text>
          <view class="tag-list">
            <block wx:for="{{flavorTypes}}" wx:key="id">
              <view
                class="optional-tag {{item.selected ? 'selected' : 'unselected'}}"
                bindtap="onOptionalTagToggle"
                data-id="{{item.id}}"
              >
                <text wx:if="{{item.selected}}" class="tag-checkmark">✓ </text>{{item.emoji}} {{item.name}}
              </view>
            </block>
          </view>
        </view>
      </block>
    </view>

    <!-- 食材清单 -->
    <view class="form-section">
      <view class="section-header">
        <text class="section-label required">食材清单</text>
        <text class="section-action" bindtap="addIngredient">
          <van-icon name="plus" size="14px" />添加食材
        </text>
      </view>

      <block wx:for="{{formData.ingredients}}" wx:key="id">
        <view class="ingredient-item">
          <van-field
            value="{{item.name}}"
            placeholder="食材名称"
            maxlength="15"
            data-index="{{index}}"
            bind:input="onIngredientNameInput"
            class="ingredient-name-field"
          />
          <van-field
            value="{{item.amount}}"
            placeholder="用量"
            maxlength="10"
            data-index="{{index}}"
            bind:input="onIngredientAmountInput"
            class="ingredient-amount-field"
          />
          <van-icon 
            wx:if="{{formData.ingredients.length > 1}}"
            name="delete" 
            size="18px" 
            color="#ff4444" 
            bindtap="removeIngredient" 
            data-index="{{index}}"
            class="delete-icon"
          />
        </view>
      </block>
    </view>

    <!-- 制作步骤 -->
    <view class="form-section">
      <view class="section-header">
        <text class="section-label required">制作步骤</text>
        <text class="section-action" bindtap="addStep">
          <van-icon name="plus" size="14px" />添加步骤
        </text>
      </view>

      <block wx:for="{{formData.steps}}" wx:key="id">
        <view class="step-item">
          <view class="step-header">
            <view class="step-number">{{index + 1}}</view>
            <van-icon
              wx:if="{{formData.steps.length > 1}}"
              name="delete"
              size="18px"
              color="#ff4444"
              bindtap="removeStep"
              data-index="{{index}}"
            />
          </view>
          
          <view class="step-content">
            <van-field
              value="{{item.content}}"
              placeholder="描述制作步骤..."
              type="textarea"
              autosize
              maxlength="200"
              show-word-limit
              data-index="{{index}}"
              bind:change="onStepContentChange"
              class="step-textarea"
            />

            <!-- 步骤图片 -->
            <view class="step-image-section">
              <block wx:if="{{item.image}}">
                <view class="step-image-item">
                  <image class="step-uploaded-image" src="{{item.image}}" mode="aspectFill" />
                  <view class="step-image-delete" bindtap="removeStepImage" data-index="{{index}}">
                    <van-icon name="cross" size="12px" color="#fff" />
                  </view>
                </view>
              </block>
              
              <text 
                wx:else
                class="step-image-upload"
                bindtap="onStepImageUpload"
                data-index="{{index}}"
              >
                <van-icon name="photograph" size="16px" />添加步骤图片
              </text>
            </view>
          </view>
        </view>
      </block>
    </view>

    <!-- 分享设置 -->
    <view class="form-section">
      <view class="privacy-setting">
        <view class="privacy-info">
          <view class="privacy-title">分享给家人</view>
          <view class="privacy-desc">开启后家人可以看到这个菜谱</view>
        </view>
        <van-switch 
          checked="{{formData.isPublic}}" 
          size="24px"
          bind:change="onPrivacyChange"
        />
      </view>
    </view>

    <!-- 底部占位 -->
    <view class="bottom-placeholder"></view>
  </scroll-view>

  <!-- 底部按钮 -->
  <view class="footer">
    <van-button 
      type="default"
      class="draft-btn"
      bind:click="onSave"
      loading="{{loading}}"
    >
      保存草稿
    </van-button>
    <van-button 
      type="primary"
      class="submit-btn"
      bind:click="onSubmit"
      loading="{{loading}}"
    >
      创建菜谱
    </van-button>
  </view>
</view>